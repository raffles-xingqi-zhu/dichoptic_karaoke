<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">
    <title>Dichoptic Karaoke App</title>

    <style>     
        body {
            font-family: "{{ font_family }}";
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;  /* Align content from top */
            padding-top: 20px;            /* Push content down slightly from top */
            height: 100vh;
            background-color: {{ bg_color }};
            color: black;
            margin: 0;
        }

        h1 {
            font-size: 56px;      /* Bigger title */
            margin: 0;            /* Remove margin so it hugs the top */
            padding: 0;           /* Remove padding */
        }

        #lyrics-display {
            font-size: 48px;
            font-weight: bold;
            margin: 50px;
            text-align: center;
            min-height: 100px;
        }
        
        /* #controls {
            margin: 20px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
        } */
        
        #time-display {
            font-size: 18px;
            color: {{bg_color}};
        }

        /* Make container fill the remaining viewport */
        #lyrics-container {
            display: flex;
            justify-content: center; /* Horizontal center */
            align-items: center;     /* Vertical center */
            flex: 1;                 /* Take remaining space after title */
            width: 100%;
        }

        #lyrics-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            min-height: 100px;
        }

    </style>
</head>
<body>
    <h1>ðŸŽ¤ Dikaro </h1>
    
    <div id="lyrics-container">
        <div id="lyrics-display"></div>
    </div>
    
    <div id="controls">
        <!-- <button id="start-btn">Start</button>
        <button id="stop-btn">Stop</button>
        <button id="reset-btn">Reset</button> -->
    </div>
    
    <div id="time-display">Time: 0.00s</div>

    <script>
        let lyricsData = [];
        let currentTime = 0;
        let isPlaying = true; // Auto-start playback
        let startTime = Date.now(); // Initialize timer immediately

        const colours = {{ adjusted_colours | tojson }};

        // Load all lyrics data when page loads
        async function loadLyrics() {
            try {
                const response = await fetch('/api/lyrics');
                lyricsData = await response.json();
                console.log('Loaded lyrics:', lyricsData);

                // Ensure timing starts after lyrics load
                startTime = Date.now();
                animationLoop(); // Start animation automatically
            } catch (error) {
                console.error('Error loading lyrics:', error);
            }
        }

        // Get the lyric for the current time using start/end time
        function getCurrentLyric(time) {
            for (let i = 0; i < lyricsData.length; i++) {
                const [start, end, text] = lyricsData[i];
                if (time >= start && time <= end) {
                    return text;
                }
            }
            return ""; // No lyric active
        }

        let lastLyric = ""; // Cache last lyric to prevent re-coloring

        function colorLyricText(lyric) {
            if (!lyric) return "";

            const words = lyric.trim().split(/\s+/);

            // If only one word, show it plain black
            if (words.length === 1) {
                return `<span style="color: black">${words[0]}</span>`;
            }

            // Otherwise, color each word only once
            return words.map(word => {
                const randomColor = colours[Math.floor(Math.random() * colours.length)];
                return `<span style="color: ${randomColor}">${word}</span>`;
            }).join(" ");
        }

        function updateDisplay() {
            const lyricDisplay = document.getElementById('lyrics-display');
            const newLyric = getCurrentLyric(currentTime);

            // Only update if lyric has changed
            if (newLyric !== lastLyric) {
                lyricDisplay.innerHTML = colorLyricText(newLyric);
                lastLyric = newLyric;
            }

            const timeDisplay = document.getElementById('time-display');
            timeDisplay.textContent = `Time: ${currentTime.toFixed(2)}s`;
        }


        // Animation loop
        function animationLoop() {
            if (isPlaying) {
                currentTime = (Date.now() - startTime) / 1000;
                updateDisplay();
                requestAnimationFrame(animationLoop);
            }
        }

        // Commented out button listeners (not used)
        /*
        document.getElementById('start-btn').addEventListener('click', () => {
            if (!isPlaying) {
                isPlaying = true;
                startTime = Date.now() - (currentTime * 1000);
                animationLoop();
            }
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            isPlaying = false;
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            isPlaying = false;
            currentTime = 0;
            updateDisplay();
        });
        */

        // Load lyrics & auto-start
        loadLyrics();
    </script>

</body>
</html>